name: Build Windows

on:
  push:
  pull_request:
    branches: [main]

env:
  ZIG_VERSION: 0.15.2

jobs:
  # NOTE: Native Windows builds are disabled due to Zig 0.15.2 bugs on Windows:
  # - https://github.com/ziglang/zig/issues/25805 (path handling on different drives)
  # - ftruncate issues with ghostty code generators
  # These should be fixed in Zig 0.16.0
  # For now, we cross-compile from macOS and test on Windows
  
  build-on-macos:
    name: macOS - Cross-compile for Windows
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Setup Zig
        uses: goto-bus-stop/setup-zig@v2
        with:
          version: ${{ env.ZIG_VERSION }}

      - name: Install dependencies
        run: bun install

      - name: Build for Windows (cross-compile)
        working-directory: packages/core/src/zig
        run: zig build -Dtarget=x86_64-windows-gnu -Doptimize=ReleaseFast

      - name: Package Windows binaries
        run: |
          mkdir -p artifacts
          cp packages/core/src/zig/lib/x86_64-windows/opentui.dll artifacts/
          ls -la artifacts/

      - name: Upload cross-compiled Windows binaries
        uses: actions/upload-artifact@v4
        with:
          name: windows-binaries-cross-compiled
          path: artifacts/opentui.dll
          if-no-files-found: error
          retention-days: 1

  test-cross-compiled-on-windows:
    name: Windows - Test macOS Cross-Compiled Binaries
    runs-on: windows-latest
    needs: build-on-macos
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Download cross-compiled Windows binaries
        uses: actions/download-artifact@v4
        with:
          name: windows-binaries-cross-compiled
          path: artifacts/

      - name: Install dependencies
        run: bun install

      - name: Setup cross-compiled binaries
        shell: bash
        run: |
          # Create the target directory
          targetDir="packages/core/node_modules/@opentui/core-win32-x64"
          mkdir -p "$targetDir"
          
          # Copy the cross-compiled DLL
          cp artifacts/opentui.dll "$targetDir/"
          
          # Create index.ts that exports the path to the DLL
          echo 'const module = await import("./opentui.dll", { with: { type: "file" } })' > "$targetDir/index.ts"
          echo 'const path = module.default' >> "$targetDir/index.ts"
          echo 'export default path;' >> "$targetDir/index.ts"
          
          # Create package.json  
          echo '{"name":"@opentui/core-win32-x64","version":"0.0.0","main":"index.ts","types":"index.ts"}' > "$targetDir/package.json"
          
          echo "Cross-compiled binary placed at:"
          ls -la "$targetDir"

      - name: Build lib (uses cross-compiled binary)
        working-directory: packages/core
        run: bun run build:lib

      - name: Run JS tests with cross-compiled binary
        working-directory: packages/core
        run: bun run test:js

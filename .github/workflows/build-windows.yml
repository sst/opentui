name: Build Windows

on:
  push:
  pull_request:
    branches: [main]

env:
  ZIG_VERSION: 0.15.2

jobs:
  build-native-windows:
    name: Windows - Native Build and Test
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Setup Zig
        uses: goto-bus-stop/setup-zig@v2
        with:
          version: ${{ env.ZIG_VERSION }}

      - name: Install dependencies
        run: bun install

      - name: Build native (Windows only)
        run: |
          cd packages/core
          bun run build:native

      - name: Verify Windows binary exists
        run: |
          if (!(Test-Path "packages/core/node_modules/@opentui/core-win32-x64/opentui.dll")) {
            Write-Error "Windows x64 binary missing!"
            exit 1
          }
          Write-Host "Windows x64 binary exists"
          Get-ChildItem "packages/core/node_modules/@opentui/core-win32-x64/"
        shell: pwsh

      - name: Run native tests
        run: |
          cd packages/core
          bun run test:native

      - name: Build lib
        run: |
          cd packages/core
          bun run build:lib

      - name: Run JS tests
        run: |
          cd packages/core
          bun run test:js

  test-cross-compiled-on-windows:
    name: Windows - Test macOS Cross-Compiled Binaries
    runs-on: windows-latest
    needs: build-on-macos
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Download cross-compiled Windows binaries
        uses: actions/download-artifact@v4
        with:
          name: windows-binaries-cross-compiled
          path: artifacts/

      - name: Install dependencies
        run: bun install

      - name: Extract and place cross-compiled binaries
        run: |
          # Create the target directory
          $targetDir = "packages/core/node_modules/@opentui/core-win32-x64"
          New-Item -ItemType Directory -Force -Path $targetDir
          
          # Copy the cross-compiled DLL
          Copy-Item "artifacts/opentui.dll" -Destination $targetDir
          
          Write-Host "Cross-compiled binary placed at:"
          Get-ChildItem $targetDir
        shell: pwsh

      - name: Build lib (uses cross-compiled binary)
        run: |
          cd packages/core
          bun run build:lib

      - name: Run JS tests with cross-compiled binary
        run: |
          cd packages/core
          bun run test:js

  build-on-macos:
    name: macOS - Cross-compile for Windows
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Setup Zig
        uses: goto-bus-stop/setup-zig@v2
        with:
          version: ${{ env.ZIG_VERSION }}

      - name: Install dependencies
        run: bun install

      - name: Build for Windows (cross-compile)
        run: |
          cd packages/core/src/zig
          zig build -Dtarget=x86_64-windows-gnu -Doptimize=ReleaseFast

      - name: Package Windows binaries
        run: |
          mkdir -p artifacts
          cp packages/core/src/zig/lib/x86_64-windows/opentui.dll artifacts/
          ls -la artifacts/

      - name: Upload cross-compiled Windows binaries
        uses: actions/upload-artifact@v4
        with:
          name: windows-binaries-cross-compiled
          path: artifacts/opentui.dll
          if-no-files-found: error
          retention-days: 1

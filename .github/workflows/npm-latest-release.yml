name: NPM Publish

on:
  workflow_call:
    inputs:
      version:
        description: "Version being published"
        required: true
        type: string
      isDryRun:
        description: "Whether this is a dry run (npm publish --dry-run)"
        required: false
        type: boolean
        default: false
    secrets:
      NPM_TOKEN:
        required: true

permissions:
  contents: write
  pull-requests: write

jobs:
  publish:
    runs-on: macos-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Setup Zig
        uses: goto-bus-stop/setup-zig@v2
        with:
          version: 0.14.1

      - name: Install dependencies
        run: bun install

      - name: Download npm packages artifact
        uses: actions/download-artifact@v4
        with:
          name: npm-packages-${{ inputs.version }}

      - name: Extract npm packages
        run: |
          echo "Extracting npm packages..."
          unzip -q npm-packages.zip

          # Copy core dist
          if [ -d "npm-packages/core-dist" ]; then
            cp -r npm-packages/core-dist packages/core/dist
            echo "Copied core dist"
          fi

          # Copy native packages to core's node_modules
          if [ -d "npm-packages/core-native-packages" ]; then
            mkdir -p packages/core/node_modules/@opentui
            cp -r npm-packages/core-native-packages/* packages/core/node_modules/@opentui/
            echo "Copied native packages"
          fi

          # Copy other package dists
          if [ -d "npm-packages/react-dist" ]; then
            cp -r npm-packages/react-dist packages/react/dist
            echo "Copied react dist"
          fi

          if [ -d "npm-packages/solid-dist" ]; then
            cp -r npm-packages/solid-dist packages/solid/dist
            echo "Copied solid dist"
          fi

          if [ -d "npm-packages/vue-dist" ]; then
            cp -r npm-packages/vue-dist packages/vue/dist
            echo "Copied vue dist"
          fi

          echo "Package extraction complete"

      - name: Publish packages (dry-run)
        if: ${{ inputs.isDryRun }}
        run: |
          echo "=========================================="
          echo "DRY RUN MODE - Not publishing to npm"
          echo "=========================================="

          # Run pre-publish validation
          bun run pre-publish

          # Show what would be published
          echo ""
          echo "Packages that would be published:"
          cd packages/core && npm publish --dry-run --access=public
          cd ../react && npm publish --dry-run --access=public
          cd ../solid && npm publish --dry-run --access=public

          echo ""
          echo "=========================================="
          echo "DRY RUN COMPLETE"
          echo "=========================================="
        env:
          NPM_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
          CI: true

      - name: Publish packages (production)
        if: ${{ !inputs.isDryRun }}
        run: bun run publish
        env:
          NPM_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
          CI: true
